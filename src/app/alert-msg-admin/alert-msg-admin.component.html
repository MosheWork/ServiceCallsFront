<div class="am-page" dir="rtl">

    <!-- =======================
         ADD / CREATE
         ======================= -->
    <mat-card class="am-card">
      <div class="am-title">הודעות מערכת (AlertMSG)</div>
  
      <div class="am-add-grid" [formGroup]="addForm">
  
        <!-- ComponentKey -->
        <mat-form-field class="am-field" appearance="outline">
          <mat-label>רכיב להצגה (ComponentKey)</mat-label>
          <mat-select formControlName="componentKey">
            <mat-option *ngFor="let k of componentKeys" [value]="k">{{ k }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <!-- MessageText -->
        <mat-form-field class="am-field" appearance="outline">
          <mat-label>טקסט הודעה</mat-label>
          <input matInput formControlName="messageText" placeholder="הקלד הודעה..." />
        </mat-form-field>
  
        <!-- Priority -->
        <mat-form-field class="am-field" appearance="outline">
          <mat-label>Priority (1-5)</mat-label>
          <mat-select formControlName="priority">
            <mat-option [value]="5">5 - קריטי</mat-option>
            <mat-option [value]="4">4 - גבוה</mat-option>
            <mat-option [value]="3">3 - בינוני</mat-option>
            <mat-option [value]="2">2 - רגיל</mat-option>
            <mat-option [value]="1">1 - נמוך</mat-option>
          </mat-select>
        </mat-form-field>
  
        <!-- Color -->
        <mat-form-field class="am-field" appearance="outline">
          <mat-label>Color (Optional)</mat-label>
          <input matInput formControlName="color" placeholder="#ef4444 / red" />
        </mat-form-field>
  
        <!-- StartAt -->
        <mat-form-field class="am-field" appearance="outline">
          <mat-label>StartAt</mat-label>
          <input matInput type="datetime-local" formControlName="startAt" />
        </mat-form-field>
  
        <!-- StopAt -->
        <mat-form-field class="am-field" appearance="outline">
          <mat-label>StopAt</mat-label>
          <input matInput type="datetime-local" formControlName="stopAt" />
        </mat-form-field>
  
        <!-- Enabled -->
        <mat-slide-toggle formControlName="isEnabled" class="am-toggle">
          פעיל
        </mat-slide-toggle>
  
        <div class="am-actions">
          <button mat-raised-button color="primary" (click)="create()" [disabled]="addForm.invalid">
            <mat-icon>add</mat-icon>
            הוסף
          </button>
        </div>
  
        <div class="am-error" *ngIf="addForm.errors?.['startAfterStop']">
            StartAt לא יכול להיות אחרי StopAt
        </div>
      </div>
  
      <div class="am-error" *ngIf="errorMessage">{{ errorMessage }}</div>
    </mat-card>
  
  
    <!-- =======================
         LIST / TABLE
         ======================= -->
    <mat-card class="am-card">
  
      <div class="am-table-head">
        <div class="am-title">רשימת הודעות</div>
  
        <mat-form-field appearance="outline" class="am-search">
          <mat-label>חיפוש</mat-label>
          <input matInput (keyup)="applyFilter($any($event.target).value)" />
        </mat-form-field>
      </div>
  
      <div class="am-loading" *ngIf="isLoading">טוען...</div>
  
      <div class="am-table-wrap" *ngIf="!isLoading">
  
        <table mat-table [dataSource]="dataSource" matSort class="am-table">
  
          <!-- ================= ID ================= -->
          <ng-container matColumnDef="alertId">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>#</th>
            <td mat-cell *matCellDef="let row">{{ row.alertId }}</td>
          </ng-container>
  
          <!-- ============== ComponentKey ============== -->
          <ng-container matColumnDef="componentKey">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Component</th>
            <td mat-cell *matCellDef="let row">
              <ng-container *ngIf="!row._isEditing; else editComp">
                {{ row.componentKey }}
              </ng-container>
  
              <ng-template #editComp>
                <mat-form-field appearance="outline" class="am-inline-field">
                  <mat-select [(ngModel)]="row._edit.componentKey">
                    <mat-option *ngFor="let k of componentKeys" [value]="k">{{ k }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </ng-template>
            </td>
          </ng-container>
  
          <!-- ============== MessageText ============== -->
          <ng-container matColumnDef="messageText">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Message</th>
            <td mat-cell *matCellDef="let row" class="am-msg-cell">
  
              <ng-container *ngIf="!row._isEditing; else editMsg">
                {{ row.messageText }}
              </ng-container>
  
              <ng-template #editMsg>
                <mat-form-field appearance="outline" class="am-inline-field am-inline-wide">
                  <input matInput [(ngModel)]="row._edit.messageText" />
                </mat-form-field>
              </ng-template>
  
            </td>
          </ng-container>
  
          <!-- ============== Priority + Color ============== -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
            <td mat-cell *matCellDef="let row">
  
              <ng-container *ngIf="!row._isEditing; else editPri">
                <span class="am-pri-badge" [style.background]="badgeColor(row)">P{{ row.priority }}</span>
                <span class="am-color-dot" [style.background]="badgeColor(row)"></span>
                <span class="am-color-text" *ngIf="row.color">({{ row.color }})</span>
              </ng-container>
  
              <ng-template #editPri>
                <div class="am-inline-row">
                  <mat-form-field appearance="outline" class="am-inline-field">
                    <mat-select [(ngModel)]="row._edit.priority">
                      <mat-option [value]="5">5</mat-option>
                      <mat-option [value]="4">4</mat-option>
                      <mat-option [value]="3">3</mat-option>
                      <mat-option [value]="2">2</mat-option>
                      <mat-option [value]="1">1</mat-option>
                    </mat-select>
                  </mat-form-field>
  
                  <mat-form-field appearance="outline" class="am-inline-field am-inline-wide">
                    <input matInput placeholder="Color (optional)" [(ngModel)]="row._edit.color" />
                  </mat-form-field>
                </div>
              </ng-template>
  
            </td>
          </ng-container>
  
          <!-- ============== StartAt ============== -->
          <ng-container matColumnDef="startAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Start</th>
            <td mat-cell *matCellDef="let row">
  
              <ng-container *ngIf="!row._isEditing; else editStart">
                {{ row.startAt ? (row.startAt | date:'dd/MM/yyyy HH:mm') : '-' }}
              </ng-container>
  
              <ng-template #editStart>
                <mat-form-field appearance="outline" class="am-inline-field">
                  <input matInput type="datetime-local" [(ngModel)]="row._edit.startAt" />
                </mat-form-field>
              </ng-template>
  
            </td>
          </ng-container>
  
          <!-- ============== StopAt ============== -->
          <ng-container matColumnDef="stopAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Stop</th>
            <td mat-cell *matCellDef="let row">
  
              <ng-container *ngIf="!row._isEditing; else editStop">
                {{ row.stopAt ? (row.stopAt | date:'dd/MM/yyyy HH:mm') : '-' }}
              </ng-container>
  
              <ng-template #editStop>
                <mat-form-field appearance="outline" class="am-inline-field">
                  <input matInput type="datetime-local" [(ngModel)]="row._edit.stopAt" />
                </mat-form-field>
              </ng-template>
  
            </td>
          </ng-container>
  
          <!-- ============== Enabled ============== -->
          <ng-container matColumnDef="isEnabled">
            <th mat-header-cell *matHeaderCellDef>פעיל</th>
            <td mat-cell *matCellDef="let row">
  
              <ng-container *ngIf="!row._isEditing; else editEnabled">
                <button mat-stroked-button (click)="toggleEnabled(row)">
                  {{ row.isEnabled ? 'כן' : 'לא' }}
                </button>
              </ng-container>
  
              <ng-template #editEnabled>
                <mat-slide-toggle [(ngModel)]="row._edit.isEnabled">פעיל</mat-slide-toggle>
              </ng-template>
  
            </td>
          </ng-container>
  
          <!-- ============== CreatedAt ============== -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>נוצר</th>
            <td mat-cell *matCellDef="let row">
              {{ row.createdAt | date:'dd/MM/yyyy HH:mm' }}
            </td>
          </ng-container>
  
          <!-- ============== Actions ============== -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>פעולות</th>
            <td mat-cell *matCellDef="let row">
  
              <ng-container *ngIf="!row._isEditing">
                <button mat-icon-button color="primary" (click)="startEdit(row)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="delete(row)">
                  <mat-icon>delete</mat-icon>
                </button>
              </ng-container>
  
              <ng-container *ngIf="row._isEditing">
                <button mat-icon-button color="primary" (click)="saveEdit(row)">
                  <mat-icon>save</mat-icon>
                </button>
                <button mat-icon-button (click)="cancelEdit(row)">
                  <mat-icon>close</mat-icon>
                </button>
              </ng-container>
  
            </td>
          </ng-container>
  
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  
        </table>
  
        <mat-paginator
          [pageSize]="10"
          [pageSizeOptions]="[10,25,50]"
          showFirstLastButtons>
        </mat-paginator>
  
      </div>
    </mat-card>
  
  </div>
  