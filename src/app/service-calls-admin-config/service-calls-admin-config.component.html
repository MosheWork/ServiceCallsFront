
<div class="admin-config" *ngIf="!isLoading" dir="rtl">
  <h1 class="page-title">
    הגדרות מערכת – קריאות שירות
  </h1>

  <mat-tab-group mat-stretch-tabs class="config-tabs">

    <!-- ===== TEAMS ===== -->
    <mat-tab label="צוותים">
      <div class="tab-header">
        <h2>צוותים אחראיים</h2>
        <button mat-raised-button color="primary" (click)="openAddSimple('team')">
          הוספת צוות
        </button>
      </div>

      <table mat-table [dataSource]="teamsDS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">
            {{ r.teamInChargeID }}
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>שם צוות</th>
          <td mat-cell *matCellDef="let r">
            {{ r.teamName }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditSimple('team', r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsTeams"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsTeams"></tr>
      </table>

      <mat-paginator #teamsPaginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== DEPARTMENTS ===== -->
    <mat-tab label="מחלקות">
      <div class="tab-header">
        <h2>מחלקות אחראיות</h2>
        <button mat-raised-button color="primary" (click)="openAddSimple('department')">
          הוספת מחלקה
        </button>
      </div>

      <table mat-table [dataSource]="departmentsDS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">
            {{ r.departmentInChargeID }}
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>שם מחלקה</th>
          <td mat-cell *matCellDef="let r">
            {{ r.departmentName }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditSimple('department', r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsDepartments"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsDepartments"></tr>
      </table>

      <mat-paginator #departmentsPaginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== STATUSES ===== -->
    <mat-tab label="סטטוסים">
      <div class="tab-header">
        <h2>סטטוס קריאה</h2>
        <button mat-raised-button color="primary" (click)="openAddSimple('status')">
          הוספת סטטוס
        </button>
      </div>

      <table mat-table [dataSource]="statusesDS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">
            {{ r.statusID }}
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>שם סטטוס</th>
          <td mat-cell *matCellDef="let r">
            {{ r.statusName }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditSimple('status', r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsStatuses"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsStatuses"></tr>
      </table>

      <mat-paginator #statusesPaginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== USERS ===== -->
    <mat-tab label="משתמשים אחראיים">
      <div class="tab-header">
        <h2>משתמשים אחראיים</h2>
        <button mat-raised-button color="primary" (click)="openAddUser()">
          הוספת משתמש
        </button>
      </div>

      <table mat-table [dataSource]="usersDS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">{{ r.userInChargeID }}</td>
        </ng-container>

        <ng-container matColumnDef="displayName">
          <th mat-header-cell *matHeaderCellDef>שם</th>
          <td mat-cell *matCellDef="let r">{{ r.displayName }}</td>
        </ng-container>

        <ng-container matColumnDef="team">
          <th mat-header-cell *matHeaderCellDef>צוות</th>
          <td mat-cell *matCellDef="let r">
            {{ getTeamName(r.teamInChargeID) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="idNo">
          <th mat-header-cell *matHeaderCellDef>ת"ז / ID_No</th>
          <td mat-cell *matCellDef="let r">{{ r.ID_No }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditUser(r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsUsers"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsUsers"></tr>
      </table>

      <mat-paginator #usersPaginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== MAIN CATEGORY ===== -->
    <mat-tab label="קטגוריות ראשיות">
      <div class="tab-header">
        <h2>קטגוריה ראשית</h2>
        <button mat-raised-button color="primary" (click)="openAddMainCategory()">
          הוספת קטגוריה
        </button>
      </div>

      <table mat-table [dataSource]="mainCatDS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">{{ r.mainCategoryID }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>שם קטגוריה</th>
          <td mat-cell *matCellDef="let r">{{ r.name }}</td>
        </ng-container>

        <ng-container matColumnDef="department">
          <th mat-header-cell *matHeaderCellDef>מחלקה אחראית</th>
          <td mat-cell *matCellDef="let r">
            {{ getDepartmentName(r.departmentInChargeID) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="team">
          <th mat-header-cell *matHeaderCellDef>צוות אחראי</th>
          <td mat-cell *matCellDef="let r">
            {{ getTeamName(r.teamInChargeID) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditMainCategory(r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsMainCat"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsMainCat"></tr>
      </table>

      <mat-paginator #mainCatPaginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== SUBCATEGORY 1 ===== -->
    <mat-tab label="תת קטגוריה 1">
      <div class="tab-header">
        <h2>תת קטגוריה 1</h2>
        <button mat-raised-button color="primary" (click)="openAddSubCategory(1)">
          הוספת תת קטגוריה 1
        </button>
      </div>

      <table mat-table [dataSource]="subCat1DS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">{{ r.subCategory1ID }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>שם</th>
          <td mat-cell *matCellDef="let r">{{ r.name }}</td>
        </ng-container>

        <ng-container matColumnDef="parent">
          <th mat-header-cell *matHeaderCellDef>קטגוריה ראשית</th>
          <td mat-cell *matCellDef="let r">
            {{ getMainCategoryName(r.mainCategoryID) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditSubCategory(1, r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsSubCat1"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsSubCat1"></tr>
      </table>

      <mat-paginator #sc1Paginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== SUBCATEGORY 2 ===== -->
    <mat-tab label="תת קטגוריה 2">
      <div class="tab-header">
        <h2>תת קטגוריה 2</h2>
        <button mat-raised-button color="primary" (click)="openAddSubCategory(2)">
          הוספת תת קטגוריה 2
        </button>
      </div>

      <table mat-table [dataSource]="subCat2DS" class="config-table mat-elevation-z1">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>מס'</th>
          <td mat-cell *matCellDef="let r">{{ r.subCategory2ID }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>שם</th>
          <td mat-cell *matCellDef="let r">{{ r.name }}</td>
        </ng-container>

        <ng-container matColumnDef="parent">
          <th mat-header-cell *matHeaderCellDef>תת קטגוריה 1</th>
          <td mat-cell *matCellDef="let r">
            {{ getMainCategoryName(r.subCategory1ID) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>פעולות</th>
          <td mat-cell *matCellDef="let r">
            <button mat-icon-button color="primary" (click)="openEditSubCategory(2, r)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsSubCat2"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsSubCat2"></tr>
      </table>

      <mat-paginator #sc2Paginator [pageSize]="10"></mat-paginator>
    </mat-tab>

    <!-- ===== SUBCATEGORY 3 ===== -->
    <mat-tab label="תת קטגוריה 3">
      <div class="tab-header">
        <h2>תת קטגוריה 3</h2>
        <button mat-raised-button color="primary" (click)="openAddSubCategory(3)">
          הוספת תת קטגוריה 3
        </button>
      </div>

     

      <mat-paginator #sc3Paginator [pageSize]="10"></mat-paginator>
    </mat-tab>

  </mat-tab-group>

  <div class="error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>
</div>

<!-- ===================================================== -->
<!--                 DIALOG TEMPLATES                      -->
<!-- ===================================================== -->

<!-- Simple (team/department/status) -->
<ng-template #simpleEditDialog>
  <h2 mat-dialog-title>
    {{ simpleType === 'team' ? 'צוות' : simpleType === 'department' ? 'מחלקה' : 'סטטוס' }}
  </h2>

  <mat-dialog-content [formGroup]="simpleForm">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>שם</mat-label>
      <input matInput formControlName="name" />
      <mat-error *ngIf="simpleForm.get('name')?.invalid">
        חובה למלא שם
      </mat-error>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>ביטול</button>
    <button mat-raised-button color="primary" (click)="saveSimple()" [disabled]="simpleForm.invalid">
      שמירה
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- UserInCharge -->
<ng-template #userEditDialog>
  <h2 mat-dialog-title>פרטי משתמש אחראי</h2>

  <mat-dialog-content [formGroup]="userForm">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>שם</mat-label>
      <input matInput formControlName="displayName" />
      <mat-error *ngIf="userForm.get('displayName')?.invalid">
        חובה למלא שם
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>ת"ז / ID_No</mat-label>
      <input matInput formControlName="ID_No" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>צוות אחראי</mat-label>
      <mat-select formControlName="teamInChargeID">
        <mat-option [value]="null">ללא</mat-option>
        <mat-option *ngFor="let t of teamsDS.data" [value]="t.teamInChargeID">
          {{ t.teamName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>ביטול</button>
    <button mat-raised-button color="primary" (click)="saveUser()" [disabled]="userForm.invalid">
      שמירה
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- MainCategory -->
<ng-template #mainCatEditDialog>
  <h2 mat-dialog-title>קטגוריה ראשית</h2>

  <mat-dialog-content [formGroup]="mainCatForm">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>שם קטגוריה</mat-label>
      <input matInput formControlName="name" />
      <mat-error *ngIf="mainCatForm.get('name')?.invalid">
        חובה למלא שם
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>מחלקה אחראית</mat-label>
      <mat-select formControlName="departmentInChargeID">
        <mat-option *ngFor="let d of departmentsDS.data" [value]="d.departmentInChargeID">
          {{ d.departmentName }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>צוות אחראי</mat-label>
      <mat-select formControlName="teamInChargeID">
        <mat-option *ngFor="let t of teamsDS.data" [value]="t.teamInChargeID">
          {{ t.teamName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>ביטול</button>
    <button mat-raised-button color="primary" (click)="saveMainCategory()" [disabled]="mainCatForm.invalid">
      שמירה
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- SubCategory 1/2/3 -->
<ng-template #subCatEditDialog>
  <h2 mat-dialog-title>
    {{ subCatLevel === 1 ? 'תת קטגוריה 1' : subCatLevel === 2 ? 'תת קטגוריה 2' : 'תת קטגוריה 3' }}
  </h2>

  <mat-dialog-content [formGroup]="subCatForm">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>שם</mat-label>
      <input matInput formControlName="name" />
      <mat-error *ngIf="subCatForm.get('name')?.invalid">
        חובה למלא שם
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>
        {{
          subCatLevel === 2 ? 'תת קטגוריה 1 אב' : 'קטגוריה ראשית אב'
        }}
      </mat-label>

      <!-- parent for level 1/3 is MainCategory, for level 2 is SubCategory1 -->
      <mat-select formControlName="parentId">
        <ng-container *ngIf="subCatLevel === 2; else mainParents">
          <mat-option *ngFor="let s of subCat1DS.data" [value]="s.subCategory1ID">
            {{ s.name }}
          </mat-option>
        </ng-container>

        <ng-template #mainParents>
          <mat-option *ngFor="let m of mainCatDS.data" [value]="m.mainCategoryID">
            {{ m.name }}
          </mat-option>
        </ng-template>
      </mat-select>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>ביטול</button>
    <button mat-raised-button color="primary" (click)="saveSubCategory()" [disabled]="subCatForm.invalid">
      שמירה
    </button>
  </mat-dialog-actions>
</ng-template>
