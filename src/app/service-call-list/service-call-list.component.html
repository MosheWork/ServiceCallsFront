

  <div class="service-call-page" dir="rtl">

    <!-- RIGHT 15% -->
    <div class="sc-col sc-right">
      <mat-card class="sc-user-card">
        <div class="sc-user-row">
          <img class="sc-user-pic" [src]="profilePictureUrl || 'assets/default-user.png'" alt="user" />
          <div class="sc-user-text">
            <div class="sc-user-name">{{ UserName || loggedUser || '专' }}</div>
            <div class="sc-user-sub">专</div>
          </div>
        </div>
      </mat-card>
    </div>
  
    <!-- MIDDLE 70% -->
    <div class="sc-col sc-center">
     

        <!-- ===== 转专转 注 + 拽专转 砖转 ===== -->
        <mat-card class="header-card">
          <div class="header-main">
            <div class="header-text">
              <h1>拽专转 砖专转</h1>
              <div class="header-subtitle">
                拽专转 砖转:
                <span class="new-count">{{ newCallsCount }}</span>
              </div>
            </div>
          </div>
        </mat-card>
    
        <!--  Filter card -->
        <mat-card class="filter-card">
          <div class="filter-row">
    
            <!-- 驻砖 驻砖 -->
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>驻砖 驻砖</mat-label>
              <input
                matInput
                [(ngModel)]="searchText"
                (ngModelChange)="applyFilter()"
                placeholder="转专转, 转专, 砖转砖, 砖..."
              />
              <button
                *ngIf="searchText"
                matSuffix
                mat-icon-button
                aria-label="拽"
                (click)="searchText=''; applyFilter()">
                <mat-icon>close</mat-icon>
              </button>
            </mat-form-field>
    
            <div class="filter-buttons">
              <button mat-stroked-button color="primary" (click)="clearFilters()">
                驻住 驻专
              </button>
              <button mat-flat-button color="primary" (click)="loadData()">
                专注
              </button>
            </div>
          </div>
        </mat-card>
    
        <!-- 爪 注 / 砖 -->
        <div class="loading-container" *ngIf="isLoading">
          <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          <div class="loading-text">注 转...</div>
        </div>
    
        <mat-card *ngIf="!isLoading && errorMessage" class="error-card">
          {{ errorMessage }}
        </mat-card>
    
        <!--  -->
        <mat-card *ngIf="!isLoading && !errorMessage">
          <div class="table-container">
            <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
    
              <!-- # ( 住专) -->
              <ng-container matColumnDef="index">
                <th mat-header-cell *matHeaderCellDef>#</th>
                <td mat-cell *matCellDef="let row; let i = index">
                  {{ i + 1 }}
                </td>
              </ng-container>
    
              <!-- 转专 驻转 + 驻专  转专 -->
              <ng-container matColumnDef="entryTime">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  <div class="header-date-filter">
                    <span class="header-title">转专 驻转</span>
    
                    <button
                      mat-icon-button
                      class="header-date-icon"
                      (click)="entryDateRangePicker.open()"
                      [ngClass]="{ 'active-filter': entryDateFrom || entryDateTo }">
                      <mat-icon>calendar_today</mat-icon>
                    </button>
    
                    <button
                      *ngIf="entryDateFrom || entryDateTo"
                      mat-icon-button
                      class="header-date-clear"
                      (click)="clearEntryDateRange($event)">
                      <mat-icon>close</mat-icon>
                    </button>
    
                    <mat-date-range-input
                      class="header-hidden-date-input"
                      [rangePicker]="entryDateRangePicker">
                      <input matStartDate [(ngModel)]="entryDateFrom" (dateChange)="onEntryDateRangeChange()">
                      <input matEndDate [(ngModel)]="entryDateTo" (dateChange)="onEntryDateRangeChange()">
                    </mat-date-range-input>
    
                    <mat-date-range-picker #entryDateRangePicker></mat-date-range-picker>
                  </div>
                </th>
    
                <td mat-cell *matCellDef="let row">
                  {{ formatDate(row.entryTime) }}
                </td>
              </ng-container>
              <!-- 转专转 + 驻专 + sort -->
    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef mat-sort-header="title">
        <div class="header-filter-wrapper">
          <span class="header-title">转专转</span>
    
          <button
            mat-icon-button
            class="header-filter-button"
            [matMenuTriggerFor]="titleMenu"
            (click)="$event.stopPropagation()">
            <mat-icon
              class="header-filter-icon"
              [ngClass]="{ 'active-filter': selectedTitles.length > 0 }">
              filter_list
            </mat-icon>
          </button>
        </div>
    
        <mat-menu #titleMenu="matMenu" xPosition="before" [overlapTrigger]="false">
          <div class="filter-menu">
            <div class="filter-menu-actions">
              <button mat-stroked-button color="primary" class="filter-action-btn"
                      (click)="selectAllTitles($event)">
                专 
              </button>
              <button mat-stroked-button color="warn" class="filter-action-btn reset"
                      (click)="clearTitleFilter($event)">
                驻住 住
              </button>
            </div>
    
            <mat-divider></mat-divider>
    
            <div class="filter-options">
              <mat-checkbox
                *ngFor="let t of distinctTitles"
                [checked]="selectedTitles.includes(t)"
                (click)="$event.stopPropagation()"
                (change)="onTitleCheckboxChange($event.checked, t)">
                {{ t }}
              </mat-checkbox>
            </div>
          </div>
        </mat-menu>
      </th>
    
      <td mat-cell *matCellDef="let row">
        {{ row.title }}
      </td>
    </ng-container>
    
              
            <!-- 砖转砖 驻转 + 驻专 + sort -->
            <ng-container matColumnDef="requestUser">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="requestUser">
                <div class="header-filter-wrapper">
                  <span class="header-title">砖转砖 驻转</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="requestUserMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedRequestUsers.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #requestUserMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllRequestUsers($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearRequestUserFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let u of distinctRequestUsers"
                        [checked]="selectedRequestUsers.includes(u)"
                        (click)="$event.stopPropagation()"
                        (change)="onRequestUserCheckboxChange($event.checked, u)">
                        {{ u }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.requestUser }}
              </td>
            </ng-container>
    
            <!-- 驻 + 驻专 + sort -->
            <ng-container matColumnDef="callbackPhone">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="callbackPhone">
                <div class="header-filter-wrapper">
                  <span class="header-title">驻</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="callbackPhoneMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedCallbackPhones.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #callbackPhoneMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllCallbackPhones($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearCallbackPhoneFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let p of distinctCallbackPhones"
                        [checked]="selectedCallbackPhones.includes(p)"
                        (click)="$event.stopPropagation()"
                        (change)="onCallbackPhoneCheckboxChange($event.checked, p)">
                        {{ p }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.callbackPhone }}
              </td>
            </ng-container>
    
            <!-- 拽专 专砖转 + 驻专 + sort -->
            <ng-container matColumnDef="mainCategoryName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="mainCategoryName">
                <div class="header-filter-wrapper">
                  <span class="header-title">拽专</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="mainCategoryMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedMainCategories.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #mainCategoryMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllMainCategories($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearMainCategoryFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let m of distinctMainCategories"
                        [checked]="selectedMainCategories.includes(m)"
                        (click)="$event.stopPropagation()"
                        (change)="onMainCategoryCheckboxChange($event.checked, m)">
                        {{ m }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.mainCategoryName }}
              </td>
            </ng-container>
    
            <!-- 转转志拽专 1 + 驻专 + sort -->
            <ng-container matColumnDef="subCategory1Name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="subCategory1Name">
                <div class="header-filter-wrapper">
                  <span class="header-title">转转志拽专 1</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="subCategory1Menu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedSubCategory1.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #subCategory1Menu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllSubCategory1($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearSubCategory1Filter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let s1 of distinctSubCategory1"
                        [checked]="selectedSubCategory1.includes(s1)"
                        (click)="$event.stopPropagation()"
                        (change)="onSubCategory1CheckboxChange($event.checked, s1)">
                        {{ s1 }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.subCategory1Name }}
              </td>
            </ng-container>
    
            <!-- 转转志拽专 2 + 驻专 + sort -->
            <ng-container matColumnDef="subCategory2Name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="subCategory2Name">
                <div class="header-filter-wrapper">
                  <span class="header-title">转转志拽专 2</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="subCategory2Menu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedSubCategory2.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #subCategory2Menu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllSubCategory2($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearSubCategory2Filter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let s2 of distinctSubCategory2"
                        [checked]="selectedSubCategory2.includes(s2)"
                        (click)="$event.stopPropagation()"
                        (change)="onSubCategory2CheckboxChange($event.checked, s2)">
                        {{ s2 }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.subCategory2Name }}
              </td>
            </ng-container>
    
            <!-- 住住 + 驻专 + sort -->
            <ng-container matColumnDef="statusName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="statusName">
                <div class="header-filter-wrapper">
                  <span class="header-title">住住</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="statusMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedStatuses.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #statusMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllStatuses($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearStatusFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let s of distinctStatuses"
                        [checked]="selectedStatuses.includes(s)"
                        (click)="$event.stopPropagation()"
                        (change)="onStatusCheckboxChange($event.checked, s)">
                        {{ s }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.statusName }}
              </td>
            </ng-container>
    
            <!-- 注驻转 + 驻专 + sort -->
            <ng-container matColumnDef="priorityName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="priorityName">
                <div class="header-filter-wrapper">
                  <span class="header-title">注驻转</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="priorityMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedPriorities.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #priorityMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllPriorities($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearPriorityFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let p of distinctPriorities"
                        [checked]="selectedPriorities.includes(p)"
                        (click)="$event.stopPropagation()"
                        (change)="onPriorityCheckboxChange($event.checked, p)">
                        {{ p }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.priorityName }}
              </td>
            </ng-container>
    
            <!-- 爪转 驻 + 驻专 + sort -->
            <ng-container matColumnDef="teamInChargeName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="teamInChargeName">
                <div class="header-filter-wrapper">
                  <span class="header-title">爪转 驻</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="teamMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedTeams.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #teamMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllTeams($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearTeamFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let t of distinctTeams"
                        [checked]="selectedTeams.includes(t)"
                        (click)="$event.stopPropagation()"
                        (change)="onTeamCheckboxChange($event.checked, t)">
                        {{ t }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.teamInChargeName }}
              </td>
            </ng-container>
    
            <!-- 砖转砖 驻 + 驻专 + sort -->
            <ng-container matColumnDef="userInChargeName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="userInChargeName">
                <div class="header-filter-wrapper">
                  <span class="header-title">砖转砖 驻</span>
    
                  <button
                    mat-icon-button
                    class="header-filter-button"
                    [matMenuTriggerFor]="userInChargeMenu"
                    (click)="$event.stopPropagation()">
                    <mat-icon
                      class="header-filter-icon"
                      [ngClass]="{ 'active-filter': selectedUsersInCharge.length > 0 }">
                      filter_list
                    </mat-icon>
                  </button>
                </div>
    
                <mat-menu #userInChargeMenu="matMenu" xPosition="before" [overlapTrigger]="false">
                  <div class="filter-menu">
                    <div class="filter-menu-actions">
                      <button mat-stroked-button
                              color="primary"
                              class="filter-action-btn"
                              (click)="selectAllUsersInCharge($event)">
                        专 
                      </button>
                      <button mat-stroked-button
                              color="warn"
                              class="filter-action-btn reset"
                              (click)="clearUserInChargeFilter($event)">
                        驻住 住
                      </button>
                    </div>
    
                    <mat-divider></mat-divider>
    
                    <div class="filter-options">
                      <mat-checkbox
                        *ngFor="let u of distinctUsersInCharge"
                        [checked]="selectedUsersInCharge.includes(u)"
                        (click)="$event.stopPropagation()"
                        (change)="onUserInChargeCheckboxChange($event.checked, u)">
                        {{ u }}
                      </mat-checkbox>
                    </div>
                  </div>
                </mat-menu>
              </th>
    
              <td mat-cell *matCellDef="let row">
                {{ row.userInChargeName }}
              </td>
            </ng-container>
    
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    
              <tr mat-row
                  *matRowDef="let row; columns: displayedColumns"
                  (click)="openDetails(row)"
                  class="clickable-row">
              </tr>
    
            </table>
          </div>
    
          <mat-paginator
            [pageSize]="20"
            [pageSizeOptions]="[10, 20, 50, 100]"
            showFirstLastButtons>
          </mat-paginator>
        </mat-card>
    
      
    </div>
  
    <!-- LEFT 15% -->
    <div class="sc-col sc-left">
      <!-- 专拽 专注 / 专住 注转 -->
      <mat-card class="sc-side-placeholder">
        <div class="ph-title">驻 爪 (注转)</div>
        <div class="ph-sub">  专住/住住拽转</div>
      </mat-card>
    </div>
  
  </div>

  <!-- LEFT: main content -->
 

