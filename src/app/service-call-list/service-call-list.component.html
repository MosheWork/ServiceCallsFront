<div class="service-call-list" dir="rtl">
  <!-- ===== כותרת עליונה + קריאות חדשות ===== -->
  <mat-card class="header-card">
    <div class="header-main">
      <div class="header-text">
        <h1>קריאות שירות</h1>
        <div class="header-subtitle">
          קריאות חדשות:
          <span class="new-count">{{ newCallsCount }}</span>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- 🔍 Filter card -->
  <mat-card class="filter-card">
    <div class="filter-row">

      <!-- חיפוש חופשי -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>חיפוש חופשי</mat-label>
        <input
          matInput
          [(ngModel)]="searchText"
          (ngModelChange)="applyFilter()"
          placeholder="כותרת, תיאור, משתמש, מחשב..."
        />
        <button
          *ngIf="searchText"
          matSuffix
          mat-icon-button
          aria-label="נקה"
          (click)="searchText=''; applyFilter()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <div class="filter-buttons">
        <button mat-stroked-button color="primary" (click)="clearFilters()">
          איפוס פילטרים
        </button>
        <button mat-flat-button color="primary" (click)="loadData()">
          רענן
        </button>
      </div>
    </div>
  </mat-card>

  <!-- מצב טעינה / שגיאה -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    <div class="loading-text">טוען נתונים...</div>
  </div>

  <mat-card *ngIf="!isLoading && errorMessage" class="error-card">
    {{ errorMessage }}
  </mat-card>

  <!-- טבלה -->
  <mat-card *ngIf="!isLoading && !errorMessage">
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">

        <!-- # (ללא סורט) -->
        <ng-container matColumnDef="index">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let row; let i = index">
            {{ i + 1 }}
          </td>
        </ng-container>

<!-- תאריך פתיחה + פילטר טווח תאריכים -->
<ng-container matColumnDef="entryTime">
  <th mat-header-cell *matHeaderCellDef mat-sort-header>
    <div class="header-date-filter">
      <span class="header-title">תאריך פתיחה</span>

      <!-- אייקון לוח שנה – פותח את ה־range picker -->
      <button
        mat-icon-button
        class="header-date-icon"
        (click)="entryDateRangePicker.open()"
        [ngClass]="{ 'active-filter': entryDateFrom || entryDateTo }">
        <mat-icon>calendar_today</mat-icon>
      </button>

      <!-- איקס לניקוי -->
      <button
        *ngIf="entryDateFrom || entryDateTo"
        mat-icon-button
        class="header-date-clear"
        (click)="clearEntryDateRange($event)">
        <mat-icon>close</mat-icon>
      </button>

      <!-- input נסתר – רק לחיבור ל־picker -->
      <mat-date-range-input
        class="header-hidden-date-input"
        [rangePicker]="entryDateRangePicker">

        <input
          matStartDate
          [(ngModel)]="entryDateFrom"
          (dateChange)="onEntryDateRangeChange()">

        <input
          matEndDate
          [(ngModel)]="entryDateTo"
          (dateChange)="onEntryDateRangeChange()">
      </mat-date-range-input>

      <mat-date-range-picker #entryDateRangePicker></mat-date-range-picker>
    </div>
  </th>

  <td mat-cell *matCellDef="let row">
    {{ formatDate(row.entryTime) }}
  </td>
</ng-container>


        <!-- שורות -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

        <tr mat-row
            *matRowDef="let row; columns: displayedColumns"
            (click)="openDetails(row)"
            class="clickable-row">
        </tr>
      </table>
    </div>

    <mat-paginator
      [pageSize]="20"
      [pageSizeOptions]="[10, 20, 50, 100]"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card>
</div>
